(function(window,document){function getRecord(e,n){return new Promise(function(r,a){e("get","/classes/Counter?where="+encodeURIComponent(JSON.stringify({target:n}))).then(t=>t.json()).then(({results:t,code:l,error:c})=>{if(l===401)throw c;if(t&&t.length>0){var u=t[0];r(u)}else e("post","/classes/Counter",{target:n,time:0}).then(o=>o.json()).then((o,i)=>{if(i)throw i;r(o)}).catch(o=>{console.error("Failed to create: ",o),a(o)})}).catch(t=>{console.error("LeanCloud Counter Error: ",t),a(t)})})}function increment(e,n){return new Promise(function(r,a){e("post","/batch",{requests:n}).then(t=>{if(t=t.json(),t.error)throw t.error;r(t)}).catch(t=>{console.error("Failed to save visitor count: ",t),a(t)})})}function buildIncrement(e){return{method:"PUT",path:`/1.1/classes/Counter/${e}`,body:{time:{__op:"Increment",amount:1}}}}function validHost(){if(CONFIG.web_analytics.leancloud.ignore_local){var e=window.location.hostname;if(e==="localhost"||e==="127.0.0.1")return!1}return!0}function validUV(){var e="LeanCloud_UV_Flag",n=localStorage.getItem(e);return n&&new Date().getTime()-parseInt(n,10)<=864e5?!1:(localStorage.setItem(e,new Date().getTime().toString()),!0)}function addCount(Counter){var enableIncr=CONFIG.web_analytics.enable&&!Fluid.ctx.dnt&&validHost(),getterArr=[],incrArr=[],pvCtn=document.querySelector("#leancloud-site-pv-container");if(pvCtn){var pvGetter=getRecord(Counter,"site-pv").then(e=>{enableIncr&&incrArr.push(buildIncrement(e.objectId));var n=document.querySelector("#leancloud-site-pv");n&&(n.innerText=(e.time||0)+(enableIncr?1:0),pvCtn.style.display="inline")});getterArr.push(pvGetter)}var uvCtn=document.querySelector("#leancloud-site-uv-container");if(uvCtn){var uvGetter=getRecord(Counter,"site-uv").then(e=>{var n=validUV()&&enableIncr;n&&incrArr.push(buildIncrement(e.objectId));var r=document.querySelector("#leancloud-site-uv");r&&(r.innerText=(e.time||0)+(n?1:0),uvCtn.style.display="inline")});getterArr.push(uvGetter)}var viewCtn=document.querySelector("#leancloud-page-views-container");if(viewCtn){var path=eval(CONFIG.web_analytics.leancloud.path||"window.location.pathname"),target=decodeURI(path.replace(/\/*(index.html)?$/,"/")),viewGetter=getRecord(Counter,target).then(e=>{enableIncr&&incrArr.push(buildIncrement(e.objectId));var n=document.querySelector("#leancloud-page-views");n&&(n.innerText=(e.time||0)+(enableIncr?1:0),viewCtn.style.display="inline")});getterArr.push(viewGetter)}enableIncr&&Promise.all(getterArr).then(()=>{incrArr.length>0&&increment(Counter,incrArr)})}var appId=CONFIG.web_analytics.leancloud.app_id,appKey=CONFIG.web_analytics.leancloud.app_key,serverUrl=CONFIG.web_analytics.leancloud.server_url;if(!appId)throw new Error("LeanCloud appId is empty");if(!appKey)throw new Error("LeanCloud appKey is empty");function fetchData(e){var n=(r,a,t)=>fetch(`${e}/1.1${a}`,{method:r,headers:{"X-LC-Id":appId,"X-LC-Key":appKey,"Content-Type":"application/json"},body:JSON.stringify(t)});addCount(n)}var apiServer=serverUrl||`https://${appId.slice(0,8).toLowerCase()}.api.lncldglobal.com`;apiServer?fetchData(apiServer):fetch("https://app-router.leancloud.cn/2/route?appId="+appId).then(e=>e.json()).then(e=>{e.api_server&&fetchData("https://"+e.api_server)})})(window,document);
